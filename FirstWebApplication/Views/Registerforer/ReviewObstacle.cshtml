@model FirstWebApplication.Entities.ObstacleData

@{
    ViewData["Title"] = "Review Obstacle";
}

<style>
    #map {
        height: 500px;
        width: 100%;
        border-radius: 8px;
    }
</style>

<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Review Obstacle #@Model.Id</h1>
            <p class="text-gray-600 mt-2">Verify information and approve or reject</p>
        </div>
        <a asp-action="PendingObstacles" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition">
            ← Back to Pending
        </a>
    </div>

    @if (TempData["Error"] != null)
    {
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
            @TempData["Error"]
        </div>
    }

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Obstacle Details -->
        <div class="lg:col-span-2">
            <!-- Info Card -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Obstacle Information</h2>
                
                <div class="space-y-4">
                    <div class="flex border-b pb-3">
                        <span class="font-semibold text-gray-700 w-40">ID:</span>
                        <span class="text-gray-900">#@Model.Id</span>
                    </div>
                    <div class="flex border-b pb-3">
                        <span class="font-semibold text-gray-700 w-40">Name:</span>
                        <span class="text-gray-900">@Model.ObstacleName</span>
                    </div>
                    <div class="flex border-b pb-3">
                        <span class="font-semibold text-gray-700 w-40">Height:</span>
                        <span class="text-gray-900">@Model.ObstacleHeight m</span>
                    </div>
                    <div class="flex border-b pb-3">
                        <span class="font-semibold text-gray-700 w-40">Description:</span>
                        <span class="text-gray-900">@Model.ObstacleDescription</span>
                    </div>
                    <div class="flex border-b pb-3">
                        <span class="font-semibold text-gray-700 w-40">Registered By:</span>
                        <span class="text-gray-900">@Model.RegisteredBy</span>
                    </div>
                    <div class="flex">
                        <span class="font-semibold text-gray-700 w-40">Registered Date:</span>
                        <span class="text-gray-900">@Model.RegisteredDate.ToString("dd.MM.yyyy HH:mm")</span>
                    </div>
                </div>
            </div>

            <!-- Map -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Location</h2>
                <div id="map"></div>
            </div>
        </div>

        <!-- Action Panel -->
        <div class="lg:col-span-1">
            <!-- Approve Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold text-green-700 mb-4">✓ Approve Obstacle</h2>
                <form asp-action="ApproveObstacle" method="post">
                    <input type="hidden" name="id" value="@Model.Id" />
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-2">Comments (Optional)</label>
                        <textarea name="approvalComments" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500"
                                  placeholder="Add any approval notes..."></textarea>
                    </div>

                    <button type="submit" 
                            class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                        Approve This Obstacle
                    </button>
                </form>
            </div>

            <!-- Reject Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-red-700 mb-4">✗ Reject Obstacle</h2>
                <form asp-action="RejectObstacle" method="post" id="rejectForm">
                    <input type="hidden" name="id" value="@Model.Id" />
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-2">Rejection Reason *</label>
                        <textarea name="rejectionReason" rows="4" required
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-red-500"
                                  placeholder="Explain why this obstacle is being rejected..."></textarea>
                        <p class="text-sm text-gray-600 mt-1">The pilot will see this reason.</p>
                    </div>

                    <button type="submit" 
                            class="w-full px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition"
                            onclick="return confirm('Are you sure you want to reject this obstacle?');">
                        Reject This Obstacle
                    </button>
                </form>
            </div>

            <!-- Info Box -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-6">
                <p class="text-sm text-yellow-800">
                    <strong>Note:</strong> Make sure to verify all information carefully before approving. Rejected obstacles can be reviewed again if needed.
                </p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize map
        const map = L.map('map').setView([58.5, 8.5], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        const wkt = '@Html.Raw(Model.ObstacleGeometry)';

        if (wkt) {
            const geometry = parseWKT(wkt);
            
            if (geometry) {
                let layer;

                if (geometry.type === 'Point') {
                    layer = L.marker([geometry.coordinates[1], geometry.coordinates[0]]);
                } else if (geometry.type === 'LineString') {
                    const coords = geometry.coordinates.map(c => [c[1], c[0]]);
                    layer = L.polyline(coords, { color: '#3498db' });
                } else if (geometry.type === 'Polygon') {
                    const coords = geometry.coordinates[0].map(c => [c[1], c[0]]);
                    layer = L.polygon(coords, { color: '#e74c3c' });
                }

                if (layer) {
                    layer.addTo(map);
                    layer.bindPopup(`
                        <strong>@Model.ObstacleName</strong><br>
                        Height: @Model.ObstacleHeight m<br>
                        Registered by: @Model.RegisteredBy
                    `).openPopup();

                    map.fitBounds(layer.getBounds ? layer.getBounds() : L.latLngBounds([layer.getLatLng()]));
                }
            }
        }

        function parseWKT(wkt) {
            if (wkt.startsWith('POINT')) {
                const coords = wkt.match(/POINT\(([-\d.]+) ([-\d.]+)\)/);
                if (coords) {
                    return { type: 'Point', coordinates: [parseFloat(coords[1]), parseFloat(coords[2])] };
                }
            } else if (wkt.startsWith('LINESTRING')) {
                const coordsStr = wkt.match(/LINESTRING\(([^)]+)\)/)[1];
                const coordinates = coordsStr.split(',').map(pair => {
                    const [lon, lat] = pair.trim().split(' ');
                    return [parseFloat(lon), parseFloat(lat)];
                });
                return { type: 'LineString', coordinates: coordinates };
            } else if (wkt.startsWith('POLYGON')) {
                const coordsStr = wkt.match(/POLYGON\(\(([^)]+)\)\)/)[1];
                const coordinates = coordsStr.split(',').map(pair => {
                    const [lon, lat] = pair.trim().split(' ');
                    return [parseFloat(lon), parseFloat(lat)];
                });
                return { type: 'Polygon', coordinates: [coordinates] };
            }
            return null;
        }
    </script>
}
