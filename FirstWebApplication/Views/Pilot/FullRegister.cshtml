@model FirstWebApplication.Models.Obstacle.RegisterObstacleViewModel

@{
    ViewData["Title"] = "Full Registration";
}

@section Head {
    <link rel="stylesheet" href="~/lib/leaflet/leaflet.css" />
    <link rel="stylesheet" href="~/lib/leaflet-draw/leaflet.draw.css" />
    <script src="~/lib/leaflet/leaflet.js"></script>
    <script src="~/lib/leaflet-draw/leaflet.draw.js"></script>

    <style>
        #map {
            position: absolute;
            top: 56px;
            left: 0;
            right: 400px;
            bottom: 0;
            z-index: 1;
        }

        .registration-form {
            position: absolute;
            top: 56px;
            right: 0;
            width: 400px;
            height: calc(100vh - 56px);
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 2;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .text-danger {
            color: #dc3545;
            font-size: 0.875rem;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background-color: #4338ca;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }
    </style>
}

<div id="map"></div>

<div class="registration-form">
    <h2 class="text-2xl font-bold mb-4">Full Registration</h2>
    <p class="text-gray-600 mb-4">Fill in all details and mark the location on the map.</p>

    <form asp-action="FullRegister" method="post">
        <div class="form-group">
            <label asp-for="ObstacleType">Obstacle Type:</label>
            <select asp-for="ObstacleType" class="form-control">
                <option value="">-- Select Type --</option>
                <option value="Mast">Mast</option>
                <option value="Tårn">Tårn</option>
                <option value="Strømledning">Strømledning</option>
                <option value="Vindturbin">Vindturbin</option>
                <option value="Bygning">Bygning</option>
                <option value="Kran">Kran</option>
                <option value="Bro">Bro</option>
                <option value="Annet">Annet</option>
            </select>
            <span asp-validation-for="ObstacleType" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="ObstacleName">Name: *</label>
            <input asp-for="ObstacleName" class="form-control" placeholder="E.g., Radio Tower" />
            <span asp-validation-for="ObstacleName" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="ObstacleHeight">Height (meters): *</label>
            <input asp-for="ObstacleHeight" type="number" step="0.1" class="form-control" placeholder="E.g., 50" />
            <span asp-validation-for="ObstacleHeight" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="ObstacleDescription">Description: *</label>
            <textarea asp-for="ObstacleDescription" class="form-control" rows="4" placeholder="Describe the obstacle..."></textarea>
            <span asp-validation-for="ObstacleDescription" class="text-danger"></span>
        </div>

        <input type="hidden" asp-for="ObstacleGeometry" id="obstacleGeometryInput" />
        <span asp-validation-for="ObstacleGeometry" class="text-danger"></span>

        <button type="submit" class="btn btn-primary w-100">Submit Registration</button>
        <a asp-action="RegisterType" class="btn btn-secondary w-100">Cancel</a>
    </form>
</div>

@section Scripts {
    <script>
        var map = L.map('map').setView([60.4720, 8.4689], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems,
                edit: true,
                remove: true
            },
            draw: {
                polygon: true,
                polyline: true,
                rectangle: true,
                circle: false,
                circlemarker: false,
                marker: true
            }
        });
        map.addControl(drawControl);

        map.on(L.Draw.Event.CREATED, function (event) {
            var layer = event.layer;
            
            drawnItems.clearLayers();
            drawnItems.addLayer(layer);
            
            var geometryWKT = convertToWKT(layer);
            document.getElementById('obstacleGeometryInput').value = geometryWKT;
        });

        map.on(L.Draw.Event.EDITED, function (event) {
            var layers = event.layers;
            layers.eachLayer(function (layer) {
                var geometryWKT = convertToWKT(layer);
                document.getElementById('obstacleGeometryInput').value = geometryWKT;
            });
        });

        map.on(L.Draw.Event.DELETED, function (event) {
            document.getElementById('obstacleGeometryInput').value = '';
        });

        function convertToWKT(layer) {
            if (layer instanceof L.Marker) {
                var latlng = layer.getLatLng();
                return `POINT(${latlng.lng} ${latlng.lat})`;
            } else if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
                var latlngs = layer.getLatLngs();
                var coords = latlngs.map(ll => `${ll.lng} ${ll.lat}`).join(',');
                return `LINESTRING(${coords})`;
            } else if (layer instanceof L.Polygon) {
                var latlngs = layer.getLatLngs()[0];
                var coords = latlngs.map(ll => `${ll.lng} ${ll.lat}`).join(',');
                var firstPoint = latlngs[0];
                coords += `,${firstPoint.lng} ${firstPoint.lat}`;
                return `POLYGON((${coords}))`;
            }
            return '';
        }
    </script>
}
