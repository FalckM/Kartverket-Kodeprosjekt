@model FirstWebApplication.Entities.ObstacleData

@{
    ViewData["Title"] = "Full Registration";
}

<!-- Leaflet Draw CSS for drawing tools -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

<style>
    #map {
        height: calc(100vh - 120px);
        width: 100%;
        position: relative;
        z-index: 0;
    }
    
    .registration-form {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 400px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        max-height: calc(100vh - 160px);
        overflow-y: auto;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
    }

    .form-control {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .form-control:focus {
        outline: none;
        border-color: #4F46E5;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
    }

    .btn-primary {
        background: #4F46E5;
        color: white;
    }

    .btn-primary:hover {
        background: #4338CA;
    }

    .btn-secondary {
        background: #6B7280;
        color: white;
        margin-top: 10px;
    }

    .btn-secondary:hover {
        background: #4B5563;
    }

    .alert {
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 15px;
    }

    .alert-info {
        background: #DBEAFE;
        color: #1E40AF;
        border: 1px solid #93C5FD;
    }

    .alert-danger {
        background: #FEE2E2;
        color: #991B1B;
        border: 1px solid #FECACA;
    }

    .text-validation-error {
        color: #DC2626;
        font-size: 12px;
        margin-top: 4px;
    }
</style>

<!-- Map Container -->
<div id="map"></div>

<!-- Registration Form (Sidebar) -->
<div class="registration-form">
    <h2 style="margin-top: 0; color: #1F2937; font-size: 24px;">Full Registration</h2>
    <p style="color: #6B7280; font-size: 14px;">Mark the obstacle on the map and provide complete details</p>

    <div class="alert alert-info">
        <strong>How to register:</strong>
        <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 13px;">
            <li>Use the marker tool on the map</li>
            <li>Click to place a marker or draw a line</li>
            <li>Fill in all required details below</li>
            <li>Click Submit to complete registration</li>
        </ul>
    </div>

    <form asp-action="SaveFullRegister" method="post" id="registrationForm">
        <!-- Hidden field for geometry -->
        <input type="hidden" asp-for="ObstacleGeometry" id="obstacleGeometry" />

        <!-- Obstacle Name -->
        <div class="form-group">
            <label asp-for="ObstacleName">Obstacle Name *</label>
            <input asp-for="ObstacleName" class="form-control" placeholder="e.g., Radio Tower, Power Line" />
            <span asp-validation-for="ObstacleName" class="text-validation-error"></span>
        </div>

        <!-- Height -->
        <div class="form-group">
            <label asp-for="ObstacleHeight">Height (meters) *</label>
            <input asp-for="ObstacleHeight" type="number" step="0.1" class="form-control" placeholder="0" />
            <span asp-validation-for="ObstacleHeight" class="text-validation-error"></span>
        </div>

        <!-- Description -->
        <div class="form-group">
            <label asp-for="ObstacleDescription">Description *</label>
            <textarea asp-for="ObstacleDescription" class="form-control" rows="4" placeholder="Provide detailed information about the obstacle..."></textarea>
            <span asp-validation-for="ObstacleDescription" class="text-validation-error"></span>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="btn btn-primary" style="width: 100%;">Complete Registration</button>
        
        <!-- Back Link -->
        <a asp-action="RegisterType" class="btn btn-secondary" style="width: 100%; display: block; text-align: center; text-decoration: none;">
            ← Back to Registration Options
        </a>
    </form>
</div>

@section Scripts {
    <!-- Leaflet Draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <script>
        // Initialize map centered on Norway
        const map = L.map('map').setView([58.5, 8.5], 6);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Create a feature group to store drawn items
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        // Initialize the draw control
        const drawControl = new L.Control.Draw({
            position: 'topleft',
            draw: {
                polygon: {
                    allowIntersection: false,
                    showArea: true,
                    shapeOptions: {
                        color: '#e74c3c'
                    }
                },
                polyline: {
                    shapeOptions: {
                        color: '#3498db'
                    }
                },
                circle: false,
                circlemarker: false,
                rectangle: {
                    shapeOptions: {
                        color: '#2ecc71'
                    }
                },
                marker: true
            },
            edit: {
                featureGroup: drawnItems,
                remove: true
            }
        });
        map.addControl(drawControl);

        // Handle when user draws something
        map.on(L.Draw.Event.CREATED, function (event) {
            const layer = event.layer;
            
            // Remove previous drawings (only allow one obstacle)
            drawnItems.clearLayers();
            
            // Add the new drawing
            drawnItems.addLayer(layer);

            // Convert to WKT format and save to hidden field
            const geoJSON = layer.toGeoJSON();
            const wkt = convertGeoJSONToWKT(geoJSON);
            document.getElementById('obstacleGeometry').value = wkt;
            
            console.log('Geometry saved:', wkt);
        });

        // Handle when user edits
        map.on(L.Draw.Event.EDITED, function (event) {
            const layers = event.layers;
            layers.eachLayer(function (layer) {
                const geoJSON = layer.toGeoJSON();
                const wkt = convertGeoJSONToWKT(geoJSON);
                document.getElementById('obstacleGeometry').value = wkt;
            });
        });

        // Handle when user deletes
        map.on(L.Draw.Event.DELETED, function (event) {
            document.getElementById('obstacleGeometry').value = '';
        });

        // Convert GeoJSON to WKT format
        function convertGeoJSONToWKT(geoJSON) {
            const geometry = geoJSON.geometry;
            const type = geometry.type;
            const coordinates = geometry.coordinates;

            if (type === 'Point') {
                return `POINT(${coordinates[0]} ${coordinates[1]})`;
            } else if (type === 'LineString') {
                const coords = coordinates.map(c => `${c[0]} ${c[1]}`).join(', ');
                return `LINESTRING(${coords})`;
            } else if (type === 'Polygon') {
                const coords = coordinates[0].map(c => `${c[0]} ${c[1]}`).join(', ');
                return `POLYGON((${coords}))`;
            }
            return '';
        }

        // Form validation
        document.getElementById('registrationForm').addEventListener('submit', function(e) {
            const geometry = document.getElementById('obstacleGeometry').value;
            
            if (!geometry) {
                e.preventDefault();
                alert('Please mark the obstacle location on the map before submitting!');
                return false;
            }
        });

        // Try to get user's location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                map.setView([lat, lon], 13);
            });
        }
    </script>

    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
