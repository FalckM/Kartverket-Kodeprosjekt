@* 
    INSTRUKSJONER FOR √Ö INSTALLERE:
    ================================
    1. √Öpne FirstWebApplication/Controllers/PilotController.cs
    2. Kopier koden fra PilotController_GetObstaclesForMap_Addition.cs 
    3. Lim inn metoden RETT F√òR den siste } i PilotController-klassen
    4. Erstatt FirstWebApplication/Views/Pilot/FullRegister.cshtml med DENNE filen
    5. Start appen og test!
*@

@model FirstWebApplication.Entities.ObstacleData

@{
    ViewData["Title"] = "Full Registration";
}

@* 
    HODE-SEKSJONEN: Importerer n√∏dvendige biblioteker
    - Leaflet = Kart-bibliotek for √• vise kart
    - Leaflet.draw = Plugin for √• tegne p√• kartet
*@
@section Head {
    <link rel="stylesheet" href="~/lib/leaflet/leaflet.css" />
    <link rel="stylesheet" href="~/lib/leaflet-draw/leaflet.draw.css" />
    <script src="~/lib/leaflet/leaflet.js"></script>
    <script src="~/lib/leaflet-draw/leaflet.draw.js"></script>

    <style>
        /* Hele siden er et stort kart med et skjema p√• siden */
        #map {
            position: absolute;
            top: 56px; /* Starter under navbar */
            left: 0;
            right: 400px; /* Gir plass til skjemaet p√• h√∏yre side */
            bottom: 0;
            z-index: 1;
        }

        /* Registreringsskjemaet som vises p√• h√∏yre side */
        .registration-form {
            position: absolute;
            top: 56px;
            right: 0;
            width: 400px;
            height: calc(100vh - 56px);
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 2;
        }

        /* Styling for input-feltene */
        .form-group {
            margin-bottom: 15px;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        /* Feilmeldinger vises i r√∏dt */
        .text-validation-error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
            display: block;
        }

        /* Knapper */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            margin-top: 10px;
        }

        /* Info-bokser */
        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        /* Responsivt design for iPad og mobil */
        @@media (max-width: 768px) {
            #map {
                right: 0;
                bottom: 50%;
            }
            
            .registration-form {
                top: auto;
                bottom: 0;
                width: 100%;
                height: 50%;
                right: 0;
            }
        }
    </style>
}

@* KARTCONTAINER - Her vises kartet *@
<div id="map"></div>

@* REGISTRERINGSSKJEMA - Vises p√• h√∏yre side *@
<div class="registration-form">
    <h2 style="margin-top: 0; color: #1F2937; font-size: 24px;">Full Registration</h2>
    <p style="color: #6B7280; font-size: 14px;">Mark the obstacle on the map and provide complete details</p>

    @* Info-boks med instruksjoner *@
    <div class="alert alert-info">
        <strong>How to register:</strong>
        <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 13px;">
            <li>üî¥ Red markers = Existing obstacles (click to view)</li>
            <li>Use the draw tools to add your obstacle</li>
            <li>Fill in all required details below</li>
            <li>Click Submit to complete registration</li>
        </ul>
    </div>

    @* SKJEMA FOR REGISTRERING *@
    <form asp-action="FullRegister" method="post" id="registrationForm">
        @* Skjult felt som lagrer GeoJSON-data fra kartet *@
        <input type="hidden" asp-for="ObstacleGeometry" id="obstacleGeometry" />

        @* OBSTACLE NAME - Navn p√• hindringen *@
        <div class="form-group">
            <label asp-for="ObstacleName">Obstacle Name *</label>
            <input asp-for="ObstacleName" class="form-control" placeholder="e.g., Radio Tower, Power Line" />
            <span asp-validation-for="ObstacleName" class="text-validation-error"></span>
        </div>

        @* OBSTACLE TYPE - Type hindring (dropdown) *@
        <div class="form-group">
            <label asp-for="ObstacleType">Obstacle Type *</label>
            <select asp-for="ObstacleType" class="form-control">
                <option value="">-- Select Type --</option>
                <option value="Tower">Tower</option>
                <option value="Power Line">Power Line</option>
                <option value="Building">Building</option>
                <option value="Crane">Crane</option>
                <option value="Antenna">Antenna</option>
                <option value="Wind Turbine">Wind Turbine</option>
                <option value="Other">Other</option>
            </select>
            <span asp-validation-for="ObstacleType" class="text-validation-error"></span>
        </div>

        @* HEIGHT - H√∏yde i meter *@
        <div class="form-group">
            <label asp-for="ObstacleHeight">Height (meters) *</label>
            <input asp-for="ObstacleHeight" type="number" step="0.1" class="form-control" placeholder="0" />
            <span asp-validation-for="ObstacleHeight" class="text-validation-error"></span>
        </div>

        @* DESCRIPTION - Beskrivelse *@
        <div class="form-group">
            <label asp-for="ObstacleDescription">Description *</label>
            <textarea asp-for="ObstacleDescription" class="form-control" rows="4" placeholder="Provide detailed information about the obstacle..."></textarea>
            <span asp-validation-for="ObstacleDescription" class="text-validation-error"></span>
        </div>

        @* SUBMIT-KNAPP *@
        <button type="submit" class="btn btn-primary">
            ‚úÖ Submit Registration
        </button>
        
        @* AVBRYT-KNAPP *@
        <a asp-action="RegisterType" class="btn btn-secondary">
            ‚ùå Cancel
        </a>
    </form>
</div>

@* 
    JAVASCRIPT-SEKSJONEN
    ====================
    Her skjer all logikken for kartet:
    1. Initialiserer kartet
    2. Laster inn eksisterende obstacles (r√∏de markers)
    3. Lar brukeren tegne nye obstacles (gr√∏nne markers)
    4. Lagrer data til skjemaet
*@
@section Scripts {
    <script>
        // GLOBALE VARIABLER
        let map;                    // Kartet
        let drawnItems;             // Layer for nye tegninger
        let existingObstaclesLayer; // Layer for eksisterende obstacles

        // KJ√òRES N√ÖR SIDEN ER FERDIG LASTET
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üó∫Ô∏è Initialiserer kart...');
            
            // STEG 1: Lag kartet
            initializeMap();
            
            // STEG 2: Last inn eksisterende obstacles
            loadExistingObstacles();
            
            // STEG 3: Sett opp tegneverkt√∏y
            setupDrawingTools();
            
            // STEG 4: Sett opp skjema-validering
            setupFormValidation();
            
            // STEG 5: Pr√∏v √• finne brukerens lokasjon
            getUserLocation();
        });

        /**
         * STEG 1: INITIALISER KARTET
         * Lager et Leaflet-kart sentrert p√• Norge
         */
        function initializeMap() {
            console.log('üìç Lager kart...');
            
            // Lag kartet sentrert p√• Norge
            map = L.map('map').setView([60.4720, 8.4689], 6);

            // Legg til kartfliser fra OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Lag layers for eksisterende og nye obstacles
            existingObstaclesLayer = L.layerGroup().addTo(map);
            drawnItems = new L.FeatureGroup().addTo(map);
            
            console.log('‚úÖ Kart initialisert!');
        }

        /**
         * STEG 2: LAST INN EKSISTERENDE OBSTACLES
         * Henter alle godkjente obstacles fra serveren via API
         */
        async function loadExistingObstacles() {
            console.log('üîç Laster inn eksisterende obstacles...');
            
            try {
                // Kall API-endepunktet som returnerer alle obstacles
                const response = await fetch('@Url.Action("GetObstaclesForMap", "Pilot")');
                
                // Sjekk om foresp√∏rselen var vellykket
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Konverter respons til JSON
                const obstacles = await response.json();
                console.log(`üìä Fant ${obstacles.length} obstacles`);
                
                // G√• gjennom hver obstacle og lag en marker
                obstacles.forEach(obstacle => {
                    addObstacleMarker(obstacle);
                });
                
                console.log('‚úÖ Eksisterende obstacles lastet inn!');
                
            } catch (error) {
                // Hvis noe g√•r galt, vis feilmelding
                console.error('‚ùå Feil ved lasting av obstacles:', error);
                alert('Failed to load existing obstacles. Please refresh the page.');
            }
        }

        /**
         * HJELPEFUNKSJON: LEGG TIL EN OBSTACLE-MARKER
         * Tar en obstacle og lager en r√∏d marker p√• kartet
         */
        function addObstacleMarker(obstacle) {
            try {
                // Parse GeoJSON fra obstacle
                const geometry = JSON.parse(obstacle.geometry);
                
                // Lag en r√∏d marker
                const marker = L.geoJSON(geometry, {
                    // Angi stil for marker (r√∏d farge)
                    style: {
                        color: '#ef4444',      // R√∏d farge
                        weight: 3,
                        opacity: 0.8
                    },
                    // For punkter: bruk r√∏de markers
                    pointToLayer: function(feature, latlng) {
                        return L.marker(latlng, {
                            icon: L.icon({
                                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34]
                            })
                        });
                    }
                });

                // Lag popup med info om obstacle
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: bold;">
                            ${obstacle.name}
                        </h3>
                        <div style="font-size: 14px; color: #666;">
                            <strong>Type:</strong> ${obstacle.type}<br>
                            <strong>Height:</strong> ${obstacle.height} m<br>
                            <strong>Status:</strong> 
                            <span style="color: green; font-weight: bold;">‚úì Approved</span>
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                marker.addTo(existingObstaclesLayer);
                
            } catch (error) {
                console.error('Feil ved parsing av obstacle:', error);
            }
        }

        /**
         * STEG 3: SETT OPP TEGNEVERKT√òY
         * Lar brukeren tegne punkter, linjer og polygoner p√• kartet
         */
        function setupDrawingTools() {
            console.log('üñäÔ∏è Setter opp tegneverkt√∏y...');
            
            // Legg til tegne-kontroller til kartet
            const drawControl = new L.Control.Draw({
                edit: {
                    featureGroup: drawnItems,
                    remove: true
                },
                draw: {
                    // Aktiver disse verkt√∏yene:
                    marker: true,      // Punkter
                    polyline: true,    // Linjer
                    polygon: true,     // Polygoner
                    
                    // Deaktiver disse:
                    circle: false,
                    rectangle: false,
                    circlemarker: false
                }
            });
            map.addControl(drawControl);

            // HENDELSE: N√•r noe tegnes p√• kartet
            map.on(L.Draw.Event.CREATED, function (event) {
                console.log('‚úèÔ∏è Ny tegning opprettet');
                
                const layer = event.layer;

                // Fjern tidligere tegninger (kun √©n obstacle om gangen)
                drawnItems.clearLayers();
                
                // Legg til den nye tegningen
                drawnItems.addLayer(layer);

                // Konverter til GeoJSON og lagre
                const geoJSON = layer.toGeoJSON();
                document.getElementById('obstacleGeometry').value = JSON.stringify(geoJSON);
                
                console.log('üíæ Geometri lagret:', geoJSON);
            });

            // HENDELSE: N√•r en tegning redigeres
            map.on(L.Draw.Event.EDITED, function (event) {
                console.log('‚úèÔ∏è Tegning redigert');
                
                const layers = event.layers;
                layers.eachLayer(function (layer) {
                    const geoJSON = layer.toGeoJSON();
                    document.getElementById('obstacleGeometry').value = JSON.stringify(geoJSON);
                });
            });

            // HENDELSE: N√•r en tegning slettes
            map.on(L.Draw.Event.DELETED, function (event) {
                console.log('üóëÔ∏è Tegning slettet');
                document.getElementById('obstacleGeometry').value = '';
            });
            
            console.log('‚úÖ Tegneverkt√∏y satt opp!');
        }

        /**
         * STEG 4: SETT OPP SKJEMA-VALIDERING
         * Sjekker at brukeren har tegnet noe f√∏r de sender inn
         */
        function setupFormValidation() {
            document.getElementById('registrationForm').addEventListener('submit', function(e) {
                const geometry = document.getElementById('obstacleGeometry').value;
                
                // Hvis ingen geometri er tegnet, stopp innsending
                if (!geometry) {
                    e.preventDefault();
                    alert('‚ùå Please mark the obstacle location on the map before submitting!');
                    return false;
                }
                
                console.log('‚úÖ Skjema sendes inn...');
            });
        }

        /**
         * STEG 5: FINN BRUKERENS LOKASJON
         * Pr√∏ver √• finne brukerens posisjon og zoome inn
         */
        function getUserLocation() {
            if (navigator.geolocation) {
                console.log('üìç Finner brukerens lokasjon...');
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        map.setView([lat, lon], 13);
                        console.log(`‚úÖ Lokasjon funnet: ${lat}, ${lon}`);
                    },
                    function(error) {
                        console.log('‚ö†Ô∏è Kunne ikke finne lokasjon:', error.message);
                    }
                );
            }
        }
    </script>

    @* Inkluder validering-scripts *@
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
