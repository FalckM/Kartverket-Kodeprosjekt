@model FirstWebApplication.Entities.ObstacleData

@{
    ViewData["Title"] = "Obstacle Overview";
}

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    #map {
        height: 500px;
        width: 100%;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .details-card {
        background: white;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .detail-row {
        display: flex;
        padding: 12px 0;
        border-bottom: 1px solid #e5e7eb;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        font-weight: 600;
        color: #374151;
        min-width: 180px;
    }

    .detail-value {
        color: #6b7280;
        flex: 1;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
    }

    .status-approved {
        background-color: #d1fae5;
        color: #065f46;
    }

    .status-rejected {
        background-color: #fee2e2;
        color: #991b1b;
    }

    .status-pending {
        background-color: #fef3c7;
        color: #92400e;
    }

    .btn {
        display: inline-block;
        padding: 10px 20px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        margin-right: 10px;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #4f46e5;
        color: white;
    }

    .btn-primary:hover {
        background: #4338ca;
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-success:hover {
        background: #059669;
    }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }

    .btn-secondary:hover {
        background: #4b5563;
    }
</style>

<div class="container mx-auto px-4 py-8">
    @if (ViewBag.IsNewRegistration == true)
    {
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6">
            <strong>✓ Success!</strong> Your obstacle has been registered successfully.
        </div>
    }

    <h1 class="text-3xl font-bold text-gray-900 mb-6">Obstacle Details #@Model.Id</h1>

    <!-- Obstacle Information -->
    <div class="details-card">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Obstacle Information</h2>

        <div class="detail-row">
            <div class="detail-label">ID:</div>
            <div class="detail-value">#@Model.Id</div>
        </div>

        <div class="detail-row">
            <div class="detail-label">Status:</div>
            <div class="detail-value">
                @if (Model.IsApproved)
                {
                    <span class="status-badge status-approved">✓ Approved</span>
                }
                else if (Model.IsRejected)
                {
                    <span class="status-badge status-rejected">✗ Rejected</span>
                }
                else
                {
                    <span class="status-badge status-pending">⏳ Pending Approval</span>
                }
            </div>
        </div>

        <div class="detail-row">
            <div class="detail-label">Name:</div>
            <div class="detail-value">@Model.ObstacleName</div>
        </div>

        @if (!string.IsNullOrEmpty(Model.ObstacleType))
        {
            <div class="detail-row">
                <div class="detail-label">Type:</div>
                <div class="detail-value">@Model.ObstacleType</div>
            </div>
        }

        <div class="detail-row">
            <div class="detail-label">Height:</div>
            <div class="detail-value">@Model.ObstacleHeight m</div>
        </div>

        <div class="detail-row">
            <div class="detail-label">Description:</div>
            <div class="detail-value">@Model.ObstacleDescription</div>
        </div>

        <div class="detail-row">
            <div class="detail-label">Registered By:</div>
            <div class="detail-value">@Model.RegisteredBy</div>
        </div>

        <div class="detail-row">
            <div class="detail-label">Registered Date:</div>
            <div class="detail-value">@Model.RegisteredDate.ToString("dd.MM.yyyy HH:mm")</div>
        </div>
    </div>

    <!-- Map -->
    <div class="details-card">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Location</h2>
        <div id="map"></div>
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-4 mt-6">
        <a asp-action="RegisterType" class="btn btn-primary">
            Register New Obstacle
        </a>
        <a asp-action="MyRegistrations" class="btn btn-success">
            View All My Registrations
        </a>
        <a asp-action="Dashboard" class="btn btn-secondary">
            Back to Dashboard
        </a>
    </div>
</div>

@section Scripts {
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Initialize map centered on Norway
        const map = L.map('map').setView([60.4720, 8.4689], 5);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Get the obstacle geometry from the model
        const geometryString = '@Html.Raw(Model.ObstacleGeometry)';

        if (geometryString) {
            try {
                // Try to parse as GeoJSON first
                const geoJSON = JSON.parse(geometryString);
                
                // It's GeoJSON! Display it
                const layer = L.geoJSON(geoJSON, {
                    style: {
                        color: '#e74c3c',
                        weight: 3,
                        opacity: 0.8
                    },
                    pointToLayer: function(feature, latlng) {
                        return L.marker(latlng);
                    }
                }).addTo(map);

                // Add popup
                layer.bindPopup(`
                    <strong>@Model.ObstacleName</strong><br>
                    Type: @Model.ObstacleType<br>
                    Height: @Model.ObstacleHeight m<br>
                    Status: ${@Model.IsApproved.ToString().ToLower() ? 'Approved' : (@Model.IsRejected.ToString().ToLower() ? 'Rejected' : 'Pending')}
                `);

                // Zoom to the obstacle
                map.fitBounds(layer.getBounds());
                
            } catch (e) {
                // Not GeoJSON, try parsing as WKT
                const geometry = parseWKT(geometryString);

                if (geometry) {
                    let layer;

                    if (geometry.type === 'Point') {
                        layer = L.marker([geometry.coordinates[1], geometry.coordinates[0]]);
                    } else if (geometry.type === 'LineString') {
                        const coords = geometry.coordinates.map(c => [c[1], c[0]]);
                        layer = L.polyline(coords, { color: '#3498db' });
                    } else if (geometry.type === 'Polygon') {
                        const coords = geometry.coordinates[0].map(c => [c[1], c[0]]);
                        layer = L.polygon(coords, { color: '#e74c3c' });
                    }

                    if (layer) {
                        layer.addTo(map);

                        // Add popup
                        layer.bindPopup(`
                            <strong>@Model.ObstacleName</strong><br>
                            Type: @Model.ObstacleType<br>
                            Height: @Model.ObstacleHeight m<br>
                            Status: ${@Model.IsApproved.ToString().ToLower() ? 'Approved' : (@Model.IsRejected.ToString().ToLower() ? 'Rejected' : 'Pending')}
                        `);

                        // Zoom to the obstacle
                        if (layer.getBounds) {
                            map.fitBounds(layer.getBounds());
                        } else {
                            // For markers (points)
                            map.setView(layer.getLatLng(), 13);
                        }
                    }
                } else {
                    console.error('Could not parse geometry');
                }
            }
        }

        // Parse WKT format (for backward compatibility)
        function parseWKT(wkt) {
            if (wkt.startsWith('POINT')) {
                const coords = wkt.match(/POINT\(([-\d.]+) ([-\d.]+)\)/);
                if (coords) {
                    return {
                        type: 'Point',
                        coordinates: [parseFloat(coords[1]), parseFloat(coords[2])]
                    };
                }
            } else if (wkt.startsWith('LINESTRING')) {
                const coordsStr = wkt.match(/LINESTRING\((.*)\)/)[1];
                const coordinates = coordsStr.split(', ').map(coord => {
                    const [lon, lat] = coord.split(' ').map(parseFloat);
                    return [lon, lat];
                });
                return { type: 'LineString', coordinates };
            } else if (wkt.startsWith('POLYGON')) {
                const coordsStr = wkt.match(/POLYGON\(\((.*)\)\)/)[1];
                const coordinates = coordsStr.split(', ').map(coord => {
                    const [lon, lat] = coord.split(' ').map(parseFloat);
                    return [lon, lat];
                });
                return { type: 'Polygon', coordinates: [coordinates] };
            }
            return null;
        }
    </script>
}
