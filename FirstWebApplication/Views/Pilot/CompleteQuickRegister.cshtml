@model FirstWebApplication.Entities.ObstacleData

@{
    ViewData["Title"] = "Complete Your Registration";
}

<style>
    #mapid {
        height: 450px;
        width: 100%;
    }
</style>

<div class="max-w-4xl mx-auto px-4 py-8 bg-white rounded-lg shadow-lg">
    <h1 class="text-3xl font-bold mb-2 text-center text-gray-800">Complete Your Registration</h1>
    <p class="text-gray-600 mb-6 text-center">Fill in the missing details for your obstacle registration</p>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="mb-4 p-4 bg-green-100 border-l-4 border-green-500 text-green-700">
            @TempData["SuccessMessage"]
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="mb-4 p-4 bg-red-100 border-l-4 border-red-500 text-red-700">
            @TempData["ErrorMessage"]
        </div>
    }

    <form asp-action="SaveCompleteQuickRegister" asp-route-quickRegId="@ViewBag.QuickRegId" method="post" class="space-y-6">
        
        <div>
            <label asp-for="ObstacleType" class="block text-sm font-medium mb-1 text-gray-700">Obstacle Type:</label>
            <select asp-for="ObstacleType" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
                <option value="">-- Select Type --</option>
                <option value="Mast">Mast</option>
                <option value="T√•rn">T√•rn</option>
                <option value="Str√∏mledning">Str√∏mledning</option>
                <option value="Vindturbin">Vindturbin</option>
                <option value="Bygning">Bygning</option>
                <option value="Kran">Kran</option>
                <option value="Bro">Bro</option>
                <option value="Annet">Annet</option>
            </select>
            <span asp-validation-for="ObstacleType" class="text-sm text-red-600"></span>
        </div>

        <div>
            <label asp-for="ObstacleName" class="block text-sm font-medium mb-1 text-gray-700">Name: *</label>
            <input asp-for="ObstacleName" placeholder="E.g., Radio Tower" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
            <span asp-validation-for="ObstacleName" class="text-sm text-red-600"></span>
        </div>

        <div>
            <label asp-for="ObstacleHeight" class="block text-sm font-medium mb-1 text-gray-700">Height in meters: *</label>
            <input asp-for="ObstacleHeight" type="number" step="0.1" placeholder="E.g., 50" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
            <span asp-validation-for="ObstacleHeight" class="text-sm text-red-600"></span>
        </div>

        <div>
            <label asp-for="ObstacleDescription" class="block text-sm font-medium mb-1 text-gray-700">Description: *</label>
            <textarea asp-for="ObstacleDescription" rows="4" placeholder="E.g., Red and white striped tower near highway" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-600"></textarea>
            <span asp-validation-for="ObstacleDescription" class="text-sm text-red-600"></span>
        </div>

        <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Location (Already Saved):</label>
            <div id="mapid" class="w-full h-80 rounded-md border border-gray-300"></div>
            <p class="text-sm text-gray-600 mt-2">
                ‚ÑπÔ∏è <strong>Note:</strong> The location was saved during quick registration and cannot be changed here.
            </p>
        </div>

        <div class="flex gap-4">
            <button type="submit" class="flex-1 inline-flex justify-center items-center rounded-md bg-blue-600 px-4 py-2 text-white font-medium hover:bg-blue-700 transition">
                üíæ Save Complete Details
            </button>
            <a asp-action="MyRegistrations" class="flex-1 inline-flex justify-center items-center rounded-md bg-gray-600 px-4 py-2 text-white font-medium hover:bg-gray-700 transition">
                ‚ùå Cancel
            </a>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const geometry = '@Html.Raw(Model.ObstacleGeometry)';

            if (geometry && geometry !== '') {
                try {
                    const wktMatch = geometry.match(/POINT\(([^ ]+) ([^ ]+)\)/);
                    
                    if (wktMatch) {
                        const longitude = parseFloat(wktMatch[1]);
                        const latitude = parseFloat(wktMatch[2]);

                        const map = L.map('mapid').setView([latitude, longitude], 15);
                        
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(map);

                        L.marker([latitude, longitude], {
                            icon: L.icon({
                                iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34],
                                shadowSize: [41, 41]
                            })
                        }).addTo(map).bindPopup('üìç Quick Registered Location').openPopup();
                    }
                } catch (error) {
                    console.error('Error displaying map:', error);
                }
            }
        });
    </script>
}
