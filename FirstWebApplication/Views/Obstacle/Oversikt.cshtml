@model IEnumerable<FirstWebApplication.Models.ObstacleData>
@using Microsoft.AspNetCore.Identity
@inject SignInManager<FirstWebApplication.Models.ApplicationUser> SignInManager
@inject UserManager<FirstWebApplication.Models.ApplicationUser> UserManager

@{
    ViewData["Title"] = "Oversikt";
    var user = User;
    var isAdmin = user.IsInRole("Admin");
}

<h2 class="mb-4 text-center font-extrabold text-3xl text-blue-700">Oversikt over registrerte luftfartshindere</h2>

<div class="bg-white p-4 rounded-2xl shadow-lg">
    <table id="obstacleTable" class="table table-striped table-bordered w-full text-center align-middle">
        <thead class="bg-blue-600 text-white">
            <tr>
                <th>Navn</th>
                <th>Høyde (m)</th>
                <th>Beskrivelse</th>
                <th>Registrert dato</th>
                <th>Registrert av</th>
                <th>Handling</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr data-id="@item.Id">
                    <td>@item.ObstacleName</td>
                    <td>@item.ObstacleHeight</td>
                    <td>@item.ObstacleDescription</td>
                    <td>@item.RegisteredDate.ToString("dd.MM.yyyy HH:mm")</td>
                    <td>@item.RegisteredBy</td>
                    <td>
                        @if (User.IsInRole("Admin") || item.RegisteredBy == User.Identity?.Name)
                        {
                            <button class="edit-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded mr-1">Rediger</button>
                        }
                        @if (User.IsInRole("Admin"))
                        {
                            <button class="delete-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">Slett</button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Modal for redigering -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-2xl w-full max-w-md shadow-2xl">
        <h3 class="text-xl font-bold text-blue-700 mb-4 text-center">Rediger hinder</h3>
        <form id="editForm">
            <input type="hidden" id="edit-id" />
            <div class="mb-3">
                <label class="block font-semibold mb-1">Navn</label>
                <input type="text" id="edit-name" class="w-full border border-gray-300 rounded-lg px-3 py-2" required />
            </div>
            <div class="mb-3">
                <label class="block font-semibold mb-1">Høyde (m)</label>
                <input type="number" id="edit-height" class="w-full border border-gray-300 rounded-lg px-3 py-2" required />
            </div>
            <div class="mb-3">
                <label class="block font-semibold mb-1">Beskrivelse</label>
                <textarea id="edit-desc" class="w-full border border-gray-300 rounded-lg px-3 py-2" required></textarea>
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" id="cancelEdit" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded">Avbryt</button>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Lagre</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <!-- DataTables -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css" />

    <script>
        $(document).ready(function () {
            const table = $('#obstacleTable').DataTable({
                order: [[3, "desc"]],
                pageLength: 10,
                language: {
                    search: "Søk:",
                    lengthMenu: "Vis _MENU_ rader per side",
                    info: "Viser _START_ til _END_ av _TOTAL_ hindere",
                    paginate: { first: "Første", last: "Siste", next: "Neste", previous: "Forrige" }
                }
            });

            // --- Rediger-knapp ---
            $('#obstacleTable').on('click', '.edit-btn', function () {
                const row = $(this).closest('tr');
                const id = row.data('id');
                const name = row.find('td:eq(0)').text();
                const height = row.find('td:eq(1)').text();
                const desc = row.find('td:eq(2)').text();

                $('#edit-id').val(id);
                $('#edit-name').val(name);
                $('#edit-height').val(height);
                $('#edit-desc').val(desc);
                $('#editModal').removeClass('hidden');
            });

            // --- Lukk modal ---
            $('#cancelEdit').click(function () {
                $('#editModal').addClass('hidden');
            });

            // --- Lagre endringer ---
            $('#editForm').submit(function (e) {
                e.preventDefault();

                const data = {
                    Id: $('#edit-id').val(),
                    ObstacleName: $('#edit-name').val(),
                    ObstacleHeight: $('#edit-height').val(),
                    ObstacleDescription: $('#edit-desc').val()
                };

                fetch('/Obstacle/Edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(res => {
                    if (res.ok) {
                        alert('Endring lagret!');
                        location.reload();
                    } else if (res.status === 403) {
                        alert('Du har ikke tilgang til å endre dette hinderet.');
                    } else {
                        alert('Noe gikk galt under lagring.');
                    }
                });
            });

            // --- Slett-knapp (kun admin) ---
            $('#obstacleTable').on('click', '.delete-btn', function () {
                const row = $(this).closest('tr');
                const id = row.data('id');
                if (confirm('Er du sikker på at du vil slette dette hinderet?')) {
                    fetch('/Obstacle/Delete/' + id, { method: 'POST' })
                        .then(res => {
                            if (res.ok) {
                                alert('Hinder slettet.');
                                location.reload();
                            } else {
                                alert('Feil under sletting.');
                            }
                        });
                }
            });
        });
    </script>
}
